<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Building AWS Route53 Resolver Outbound Endpoints with Terraform - Brett Bim</title>
<meta name="description" content="At work, we are moving out of an legacy data center to AWS.  Our initial stab at that has been to stand up a staging environment that clients can use to verify changes.  Currently, we have several Docker Swarms that run different services.  These services use Traefik as an application gateway to route requests from client applications.  To facilitate this, we need URLs for particular sections of our application stack like preprod-dmz.example.com.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brett Bim">
<meta property="og:title" content="Building AWS Route53 Resolver Outbound Endpoints with Terraform">
<meta property="og:url" content="http://brettbim.com/technology/2023/09/11/aws-route53-outbound-endpoint.html">


  <meta property="og:description" content="At work, we are moving out of an legacy data center to AWS.  Our initial stab at that has been to stand up a staging environment that clients can use to verify changes.  Currently, we have several Docker Swarms that run different services.  These services use Traefik as an application gateway to route requests from client applications.  To facilitate this, we need URLs for particular sections of our application stack like preprod-dmz.example.com.">







  <meta property="article:published_time" content="2023-09-11T00:00:00+00:00">






<link rel="canonical" href="http://brettbim.com/technology/2023/09/11/aws-route53-outbound-endpoint.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://brettbim.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Brett Bim Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Brett Bim
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/lifelong-bird-list/">Lifelong Birding List</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Building AWS Route53 Resolver Outbound Endpoints with Terraform">
    <meta itemprop="description" content="At work, we are moving out of an legacy data center to AWS.  Our initial stab at that has been to stand up a staging environment that clients can use to verify changes.  Currently, we have several Docker Swarms that run different services.  These services use Traefik as an application gateway to route requests from client applications.  To facilitate this, we need URLs for particular sections of our application stack like preprod-dmz.example.com.">
    <meta itemprop="datePublished" content="2023-09-11T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Building AWS Route53 Resolver Outbound Endpoints with Terraform
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>At work, we are moving out of an legacy data center to AWS.  Our initial stab at that has been to stand up a staging environment that clients can use to verify changes.  Currently, we have several Docker Swarms that run different services.  These services use <a href="https://traefik.io/">Traefik</a> as an application gateway to route requests from client applications.  To facilitate this, we need URLs for particular sections of our application stack like <code class="language-plaintext highlighter-rouge">preprod-dmz.example.com</code>.</p>

<p>Normally, in a purely cloud environment, this would be straightforward.  We’d set up a hosted zone and utilize Route53 to create and manage these zones.  However, DNS is not something we migrating immediately and we still wanted to use <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/dns-and-ad-ds">Active Directory</a> to manage our DNS.  We needed a way for the EC2 instances that host the Docker Swarms to be able to resolve DNS in our on-prem domain controllers.  We explored two options, Private Hosted Zones and AWS Route53 Resolver endpoints.  In the end, the latter seemed the easiest to set up.</p>

<p>This post details how we went about setting this up.  As always, the AWS documentation seemed to be missing a few critical pieces for a real world app that bit us but overall, this was a pretty easy process.  We use Terragrunt and Terraform to provision infrastructure.</p>

<p>One thing to note: these nodes are not currently on our domain which is why we’re going this direction.  Obviously, if we joined them to the domain, DNS resolution would probably be a trivial matter.  However in the short term, we have not done that as we expect to migrate away from Docker Swarm to managed services in AWS.</p>

<p>AWS Route53 Resolver has two ways to manage DNS queries: Inbound and Outbound endpoints.  The former is used to send DNS queries from your on-prem network to DNS resolvers in AWS.  The latter is the opposite.  For now, we only have a use case for Outbound, e.g. sending DNS queries in the Swarms to our on-prem domain controllers.</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="s2">"resolver_sg"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./security_group"</span>

  <span class="nx">name</span>         <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">description</span>  <span class="p">=</span> <span class="s2">"Security group for forwarding endpoints in AWS Resolver"</span>
  <span class="nx">vpc_id</span>       <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">vpc_id</span>
  <span class="nx">tags</span>         <span class="p">=</span> <span class="nx">merge</span><span class="p">(</span><span class="kd">local</span><span class="p">.</span><span class="nx">tags</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">name</span> <span class="p">})</span>
  <span class="nx">egress_rules</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">egress_rules</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First, we need a security group.  This is where the one gotcha that we ran into lies.  Intuitively, and in the AWS docs, for an Outbound Endpoint, you’d assume you needed an Egress Rule of tcp(DNS) on port 53.  However, this assumption would be wrong.  More on that to follow.</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"aws_route53_resolver_endpoint"</span> <span class="s2">"endpoint"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">direction</span>          <span class="p">=</span> <span class="s2">"OUTBOUND"</span>
  <span class="nx">security_group_ids</span> <span class="p">=</span> <span class="p">[</span><span class="k">module</span><span class="p">.</span><span class="nx">resolver_sg</span><span class="p">.</span><span class="nx">security_group</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>

  <span class="nx">dynamic</span> <span class="s2">"ip_address"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">domains</span>

    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">subnet_id</span> <span class="p">=</span> <span class="nx">ip_address</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">subnet_id</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="kd">local</span><span class="p">.</span><span class="nx">tags</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, you need the endpoint definition.  In this case, it’s an OUTBOUND endpoint.  We build the ip_address section dynamically based on how many domains are passed in.</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"aws_route53_resolver_rule"</span> <span class="s2">"rule"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">domains</span>

  <span class="nx">domain_name</span>          <span class="p">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">domain_name</span>
  <span class="nx">rule_type</span>            <span class="p">=</span> <span class="s2">"FORWARD"</span>
  <span class="nx">name</span>                 <span class="p">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">key</span>
  <span class="nx">resolver_endpoint_id</span> <span class="p">=</span> <span class="nx">aws_route53_resolver_endpoint</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">target_ip</span> <span class="p">{</span>
    <span class="nx">ip</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">domain_controller_ip</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="kd">local</span><span class="p">.</span><span class="nx">tags</span>

<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_route53_resolver_rule_association"</span> <span class="s2">"assoc"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">aws_route53_resolver_rule</span><span class="p">.</span><span class="nx">rule</span>

  <span class="nx">resolver_rule_id</span> <span class="p">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">vpc_id</span>           <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">vpc_id</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally we build the rules that the Resolver uses to know to forward queries based on the domains.  The <code class="language-plaintext highlighter-rouge">target_ip</code> is our domain controller for this environment.</p>

<p>When this Terraform was executed, it seemed to properly set up the required infrastructure.  First glance at a domain in the zone resolved the URL properly.  However, upon further examination, lots of the queries were timing out and returning a SERVFAIL when using <code class="language-plaintext highlighter-rouge">dig</code>.</p>

<p>To diagnose the problem, we turned on <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-query-logs.html">Resolver Query Logging</a>.  This made the problem immediately apparent when logs like this started coming through:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.100000"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"account_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"111111111"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"vpc_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vpc-thevpc"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"query_timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-09-11T19:01:45Z"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"query_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"preprod-dmz.example.com."</span><span class="p">,</span><span class="w">
     </span><span class="nl">"query_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"query_class"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IN"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"rcode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SERVFAIL"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"answers"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
     </span><span class="nl">"srcaddr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.100.51.140"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"srcport"</span><span class="p">:</span><span class="w"> </span><span class="s2">"38214"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"transport"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UDP"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"srcids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"i-someinstanceid"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"resolver_endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rslvr-out-resolverid"</span><span class="w">
     </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>These queries are coming across UDP and so only having Egress Rules on the security group for port 53 and TCP was clearly not going to work.  We added the UDP ports in our Terragrunt along with a CIDR restriction of our internal network and suddenly, the DNS resolution started happening on the Outbound Endpoints.</p>

<p>Overall, this was an easy setup with only the one gotcha.  We now have URLs successfully resolving in Docker Swarm on EC2 instances by forwarding specific queries to our own prem domain controller.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-09-11T00:00:00+00:00">September 11, 2023</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Building+AWS+Route53+Resolver+Outbound+Endpoints+with+Terraform%20http%3A%2F%2Fbrettbim.com%2Ftechnology%2F2023%2F09%2F11%2Faws-route53-outbound-endpoint.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fbrettbim.com%2Ftechnology%2F2023%2F09%2F11%2Faws-route53-outbound-endpoint.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fbrettbim.com%2Ftechnology%2F2023%2F09%2F11%2Faws-route53-outbound-endpoint.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/technology/2023/06/13/wordpress-to-jekyll.html" class="pagination--pager" title="Migrating From Wordpress to Jekyll
">Previous</a>
    
    
      <a href="/hunting/outdoors/2024/01/20/gus-engling-deer-hunt.html" class="pagination--pager" title="Gus Engling Deer Hunt 2023
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/hunting/outdoors/2024/01/20/gus-engling-deer-hunt.html" rel="permalink">Gus Engling Deer Hunt 2023
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">My entries into the Texas Parks and Wildlife draw hunt season won me four hunts in 2023-2024.  The first of these was the last hunt of the season at Gus Enge...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/technology/2023/06/13/wordpress-to-jekyll.html" rel="permalink">Migrating From Wordpress to Jekyll
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I have been a Wordpress user for about as long as I have been writing online.  I have blog posts going back at least to 2005.  I have always enjoyed Wordpres...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/travel/2023/05/28/lakeview-arkansas-rivercliff.html" rel="permalink">Thoughts from Rivercliff, Lakeview AR
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">This was supposed to be the annual fishing trip with Dad.  Every year, for the past 20 or so, we’ve taken a trip to Arkansas to trout fish and play golf, oft...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/technology/2022/01/28/lightsail-bitnami-and-ssh.html" rel="permalink">Lightsail, Bitnami and SSH
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">This blog runs in Lightsail on WordPress with a Certified by Bitnami instance. Lately, I’ve run into the following when trying to ssh in from the Lightsail c...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 Brett Bim. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
